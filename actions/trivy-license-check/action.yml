name: 'Trivy License Check'
description: 'Check licenses using Trivy with custom policy'

inputs:
  image_name:
    description: 'Docker image name to scan. If not provided, filesystem scan will be performed.'
    required: false
  scan_ref:
    description: 'Target to scan (image name or filesystem path). Default is current directory.'
    required: false
    default: '.'
  scan_type:
    description: 'Scan type: "image" or "fs". Default is "fs".'
    required: false
    default: 'fs'
  policy_repo:
    description: 'Policy repository (e.g., org/common-policies). If not provided, uses anyfld/vistra-pj.'
    required: false
  policy_path:
    description: 'Path to policy file within the policy repository.'
    required: false
    default: 'configs/policy/license.rego'

runs:
  using: 'composite'
  steps:
    - name: Checkout Policy Repository
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.policy_repo || 'anyfld/vistra-pj' }}
        path: policy

    - name: Set Policy Path
      id: set-policy-path
      run: |
        echo "path=policy/${{ inputs.policy_path }}" >> "$GITHUB_OUTPUT"
      shell: bash

    - name: Set Scan Target
      id: set-scan-target
      run: |
        if [ "${{ inputs.scan_type }}" = "image" ] && [ -n "${{ inputs.image_name }}" ]; then
          echo "target=${{ inputs.image_name }}" >> "$GITHUB_OUTPUT"
        else
          echo "target=${{ inputs.scan_ref }}" >> "$GITHUB_OUTPUT"
        fi
      shell: bash

    - name: Run Trivy License Check
      id: trivy-check
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: ${{ inputs.scan_type }}
        scan-ref: ${{ steps.set-scan-target.outputs.target }}
        scanners: 'license'
        ignore-policy: ${{ steps.set-policy-path.outputs.path }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        exit-code: '1'
      continue-on-error: true

    - name: Install Trivy and jq
      if: github.event_name == 'pull_request'
      run: |
        if ! command -v jq &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y jq
        fi
        if ! command -v trivy &> /dev/null; then
          VERSION=$(curl -s https://api.github.com/repos/aquasecurity/trivy/releases/latest | jq -r '.tag_name' | sed 's/v//')
          wget -qO - "https://github.com/aquasecurity/trivy/releases/download/v${VERSION}/trivy_${VERSION}_Linux-64bit.tar.gz" | tar -xz
          sudo mv trivy /usr/local/bin/
        fi
      shell: bash

    - name: Get Trivy License Results (JSON)
      id: trivy-json
      if: github.event_name == 'pull_request'
      run: |
        trivy ${{ inputs.scan_type }} \
          --scanners license \
          --ignore-policy ${{ steps.set-policy-path.outputs.path }} \
          --format json \
          --output trivy-results.json \
          ${{ steps.set-scan-target.outputs.target }} || true
        if [ -f trivy-results.json ]; then
          echo "results_file=trivy-results.json" >> "$GITHUB_OUTPUT"
        fi
      shell: bash

    - name: Format License Results for Comment
      id: format-comment
      if: github.event_name == 'pull_request' && steps.trivy-json.outputs.results_file != ''
      run: |
        if [ -f "${{ steps.trivy-json.outputs.results_file }}" ]; then
          # Extract license information from JSON and format as markdown table
          COMMENT=$(jq -r '
            def format_licenses:
              if .Results and (.Results | length > 0) then
                "## üìã „É©„Ç§„Çª„É≥„ÇπÊÉÖÂ†±\n\n" +
                "<details>\n<summary>„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„É©„Ç§„Çª„É≥„ÇπÊÉÖÂ†±„ÇíË°®Á§∫</summary>\n\n" +
                "| „Éë„ÉÉ„Ç±„Éº„Ç∏Âêç | „Éê„Éº„Ç∏„Éß„É≥ | „É©„Ç§„Çª„É≥„Çπ |\n" +
                "|------------|----------|----------|\n" +
                (
                  .Results[] |
                  if .Packages then
                    .Packages[] |
                    select(.Licenses != null and (.Licenses | length > 0)) |
                    "| \(.Name // "N/A") | \(.Version // "N/A") | \(.Licenses | join(", ")) |\n"
                  elif .Licenses then
                    .Licenses[] |
                    "| \(.PkgName // .Name // "N/A") | \(.PkgVersion // .Version // "N/A") | \(.Name // "N/A") |\n"
                  else
                    empty
                  end
                ) +
                "\n</details>"
              else
                "## üìã „É©„Ç§„Çª„É≥„ÇπÊÉÖÂ†±\n\n„É©„Ç§„Çª„É≥„ÇπÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ"
              end;

            format_licenses
          ' "${{ steps.trivy-json.outputs.results_file }}" 2>/dev/null || echo "## üìã „É©„Ç§„Çª„É≥„ÇπÊÉÖÂ†±\n\n„É©„Ç§„Çª„É≥„ÇπÊÉÖÂ†±„ÅÆÂèñÂæó‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ")

          # Save to file for multiline output
          echo "$COMMENT" > license-comment.md
          echo "comment_file=license-comment.md" >> "$GITHUB_OUTPUT"
        fi
      shell: bash

    - name: Add PR Comment with License Information
      if: github.event_name == 'pull_request' && steps.format-comment.outputs.comment_file != ''
      uses: mshick/add-pr-comment@b8f338c590a895d50bcbfa6c5859251edc8952fc
      with:
        message-path: ${{ steps.format-comment.outputs.comment_file }}
        message-id: trivy-license-check
        allow-repeats: true
